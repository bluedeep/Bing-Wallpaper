name: Daily update

on:
  schedule:
    # 北京时间: 7:02, 15:02, 18:02, 21:02, 23:02
    # UTC 时间: 23:02, 7:02, 10:02, 13:02, 15:02
    # 提前规划半小时左右, 防止github workflow延迟
    - cron: '22 22 * * *'  # 23:00 UTC = 7:00 Beijing
    - cron: '22 6 * * *'   # 7:00 UTC = 15:00 Beijing
    - cron: '22 9 * * *'  # 10:00 UTC = 18:00 Beijing
    - cron: '22 12 * * *'  # 13:00 UTC = 21:00 Beijing
    - cron: '22 14 * * *'  # 15:00 UTC = 23:00 Beijing
  workflow_dispatch:

# permissions: {}  # Using PAT
permissions:
  contents: write  # 必需：推送提交
  actions: read    # 可选：读取工作流
  checks: write   # 可选：如果需要创建检查

concurrency:
  group: "daily_update"
  cancel-in-progress: false

jobs:
  update-images:
    name: Update images
    runs-on: ubuntu-latest

    steps:
      - name: Clone repository
        uses: actions/checkout@v5

      - name: Install Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.14
          cache: pip

      - name: Install dependencies
        working-directory: src
        run: pip install -r requirements.txt

      - name: Update archive
        working-directory: src
        run: python update.py

      - name: Get previous commit author
        id: previous_commit
        run: echo "PREVIOUS_COMMIT_AUHOUR=$(git log -1 --pretty=%an)" >> "$GITHUB_OUTPUT"

      - name: Commit and push changes (amend previous update)
        if: ${{ steps.previous_commit.outputs.PREVIOUS_COMMIT_AUHOUR == 'GitHub Actions' }}
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: Archive update
          commit_user_name: GitHub Actions
          commit_author: GitHub Actions <41898282+github-actions[bot]@users.noreply.github.com>
          commit_options: --amend --no-edit
          push_options: --force
          skip_fetch: true

      - name: Commit and push changes
        if: ${{ steps.previous_commit.outputs.PREVIOUS_COMMIT_AUHOUR != 'GitHub Actions' }}
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: Archive update
          commit_user_name: GitHub Actions
          commit_author: GitHub Actions <41898282+github-actions[bot]@users.noreply.github.com>
